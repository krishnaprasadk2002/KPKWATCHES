<%- include('../layouts/user/userHeader') %>

    <div class="page-wrapper">
        <header class="header header-11">
            <div class="header-middle sticky-header">
                <div class="container">
                    <div class="header-left">
                        <nav class="main-nav">
                            <ul class="menu sf-arrows">
                                <li class="megamenu-container active">
                                    <a href="#">Home</a>
                                </li>
                                <li>
                                    <a href="/product">Shop</a>

                                </li>

                                <li><a href="/about">About</a></li>


                                <li><a href="/contact">Contact</a></li>
                                <li hidden><a href="#">Blog</a></li>
                            </ul><!-- End .menu -->

                        </nav><!-- End .main-nav -->

                        <button class="mobile-menu-toggler">
                            <span class="sr-only">Toggle mobile menu</span>
                            <i class="icon-bars"></i>
                        </button>
                    </div><!-- End .header-left -->

                    <div class="header-center">
                        <a href="#" class="logo mr-3">
                            <img src="/uploads/LOGO/KPK_WATCHES_LOGO-removebg-preview.png" alt="KPK Logo" width="82"
                                height="25">
                        </a>
                    </div><!-- End .header-center -->

                    <div class="header-right">
                        <div class="header-search header-search-extended header-search-visible ml-5" hidden>
                            <a href="#" class="search-toggle" role="button"><i class="icon-search"></i></a>
                            <form action="#" method="get">
                                <div class="header-search-wrapper">
                                    <label for="q" class="sr-only">Search</label>
                                    <input type="search" class="form-control" name="q" id="q"
                                        placeholder="Search product ..." required>
                                    <button class="btn btn-primary" type="submit"><i class="icon-search"></i></button>
                                </div><!-- End .header-search-wrapper -->
                            </form>
                        </div><!-- End .header-search -->

                        <a href="/wishlist" class="wishlist-link">
                            <i class="icon-heart-o"></i>
                        </a>

                        <div class="dropdown cart-dropdown" id="cart-count">
                            <a href="/cart" class="dropdown-toggle" role="button" aria-haspopup="true"
                                aria-expanded="false" data-display="static">
                                <i class="icon-shopping-cart"></i>
                                <%if(locals.cart){%> <span class="cart-count">
                                        <%= cart.products.length %>
                                    </span>
                                    <%}else{%>
                                        <span class="cart-count">0</span>
                                        <%}%>
                            </a>
                        </div><!-- End .cart-dropdown -->

                        <% if (locals.username) { %>
                            <div class="ml-5"> <!-- Adjusted margin -->
                                <div class="dropdown">
                                    <button class="btn btn-secondary dropdown-toggle" type="button"
                                        id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true"
                                        aria-expanded="false">
                                        <%= username.name %>
                                    </button>
                                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                        <a class="dropdown-item" href="/profile">Profile</a>
                                        <a class="dropdown-item" href="/logout">Logout</a>
                                    </div>
                                </div>
                            </div>
                            <% } else { %>
                                <div class="ml-5"> <!-- Adjusted margin -->
                                    <div class="dropdown">
                                        <button class="btn btn-secondary dropdown-toggle" type="button"
                                            id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true"
                                            aria-expanded="false">
                                            Guest
                                        </button>
                                        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                            <a class="dropdown-item" href="/login">Log in</a>
                                        </div>
                                    </div>
                                </div>
                                <% } %>




                    </div><!-- End .header-right -->
                </div><!-- End .container -->
            </div><!-- End .header-middle -->
        </header><!-- End .header -->



        <main class="main">
            <div class="intro-slider-container mb-3 mb-lg-5">
                <div class="intro-slider owl-carousel owl-theme owl-nav-inside owl-light" data-toggle="owl"
                    data-owl-options='{"dots": true, "nav": false, "autoplay": true, "autoplayTimeout": 5000}'>

                    <% banner.forEach((banner)=> { %>
                        <div class="intro-slide"
                            style="background-image: url('/uploads/<%= encodeURIComponent(banner.image) %>')">
                            <div class="container">
                                <div class="intro-content text-center">
                                    <h3 class="intro-subtitle cross-txt text-primary">
                                        <%= banner.description %>
                                    </h3>
                                    <h1 class="intro-title text-white">
                                        <%= banner.title %>
                                    </h1>
                                    <div class="intro-action cross-txt">
                                        <a href="/product" class="btn btn-outline-white">
                                            <span>Discover More</span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <% }) %>

                </div>


                <span class="slider-loader text-white"></span><!-- End .slider-loader -->
            </div><!-- End .intro-slider-container -->

            <div class="container banners" hidden>
                <div class="row">
                    <div class="col-lg-6">
                        <div class="banner banner-hover">
                            <a href="#">
                                <img src=" ../user/assets/images/banners/BannerWatches.jpg  " alt="Banner"></a>
                            <br>
                            <a href="#"> <img src="../user/assets/images/banners/watche2.jpg" alt="Banner"></a>


                            <div class="banner-content">
                                <h3 class="banner-title text-white"><a href="#">Omega Speedmaster Silver Snoopy Award
                                        50th Anniversary</a></h3><!-- End .banner-title -->
                                <a href="#" class="banner-link">Shop Now <i class="icon-long-arrow-right"></i></a>
                            </div><!-- End .banner-content -->
                        </div><!-- End .banner -->
                    </div><!-- End .col-lg-6 -->

                    <div class="col-sm-6 col-lg-3">
                        <div class="banner banner-hover">
                            <a href="#">
                                <img src="../user/assets/images/Hublot.jpg" alt="Banner" style="height: 540px;">
                            </a>

                            <div class="banner-content">
                                <h3 class="banner-title text-white"><a href="#">MP-15 TAKASHI MURAKAMI TOURBILLON
                                        SAPPHIRE</a></h3><!-- End .banner-title -->
                                <a href="#" class="banner-link">Shop Now <i class="icon-long-arrow-right"></i></a>
                            </div><!-- End .banner-content -->
                        </div><!-- End .banner -->
                    </div><!-- End .col-sm-6 -->

                    <div class="col-sm-6 col-lg-3">
                        <div class="banner banner-hover">
                            <a href="#">
                                <img src="../user/assets/images/banners/watches 3.jpg" alt="Banner"
                                    style="height: 260px;">
                            </a>

                            <div class="banner-content">
                                <h3 class="banner-title text-white"><a href="#">Premium Collections</a></h3>
                                <!-- End .banner-title -->
                                <a href="#" class="banner-link">Shop Now <i class="icon-long-arrow-right"></i></a>
                            </div><!-- End .banner-content -->
                        </div><!-- End .banner -->

                        <div class="banner banner-hover">
                            <a href="#">
                                <img src="../user/assets/images/banners/04-Internal-Banner1050X466-1.jpg" alt="Banner"
                                    style="height: 260px;">
                            </a>

                            <div class="banner-content">
                                <h3 class="banner-title text-white"><a href="#">Parmigiani Fleurier Toric Tourbillon
                                        Slate Edition</a></h3><!-- End .banner-title -->
                                <a href="#" class="banner-link">Shop Now <i class="icon-long-arrow-right"></i></a>
                            </div><!-- End .banner-content -->
                        </div><!-- End .banner -->
                    </div><!-- End .col-sm-6 -->
                </div><!-- End .row -->
            </div><!-- End .container -->


            <div class="container">
                <style>
                    .product-price {
                        font-size: 16px;
                        margin-bottom: 5px;
                    }

                    .original-price {
                        text-decoration: line-through;
                        color: #999;
                        /* Optional: Adjust the color to your preference */
                    }

                    .offer-price {
                        color: #e44d26;
                        /* Optional: Adjust the color to your preference */
                        font-weight: bold;
                        /* Optional: Adjust the font weight to your preference */
                    }
                </style>


                <div class="row">
                    <div class="text-center">
                        <h2 class="title mb-4">Recent Arrivals</h2>
                    </div>
                </div>
                <div class="products-container">
                    <div class="row">
                        <% filteredProducts.forEach(product=> { %>
                            <div class="col-6 col-md-3 mb-4">
                                <div class="product product-4" style="width: 280px; height: 500px;">
                                    <figure class="product-media">
                                        <a href="/eachproduct/?id=<%= product._id%>">
                                            <img src="/uploads/<%= product.image[0] %>" alt="Product image"
                                                class="product-image" style="width: 100%; height: 300px">
                                        </a>
                                        <div class="product-action row">
                                            <div class="col-6">
                                                <input type="hidden" id="qty" class="form-control" value="1" min="1"
                                                    max="<%=product.quentity%>" step="1" data-decimals="0" required>
                                            </div>

                                            <div class="col-12">
                                                <a href="#"
                                                    onclick="addtoCart('<%=product._id%>', '<%=locals.username%>,')"
                                                    class="btn-product btn-cart"><span>Add to Cart</span></a>
                                            </div>
                                        </div><!-- End .product-action -->


                                    </figure>



                                    <div class="product-body">
                                        <h3 class="product-title"><a href="/eachproduct/?id=<%= product._id%>"><b>
                                                    <%=product.name%></a></b></h3>
                                        <div class="product-cat">
                                            <p>
                                                <%= product.category.name %>
                                            </p>
                                        </div>

                                        <div class="product-price">
                                            <% if (product.offer || product.category.offer) { %>
                                                <br>
                                                <span class="original-price">₹<%= product.price %></span>
                                                <span class="offer-price">
                                                    <%= product.offer ? product.offer.discount : product
                                                        .category.offer.discount %> % Off
                                                </span><br>
                                                <span class="offer h-75" style="color: green; font:bold">₹<%=
                                                        product.offerprice %></span>



                                                <% } else { %>
                                                    ₹<%= product.price %>
                                                        <% } %>
                                        </div>


                                    </div>
                                </div>
                            </div>
                            <% }) %>
                    </div>


                    <div class="more-container text-center mt-0 mb-0">
                        <a href="/product" class="btn btn-outline-primary-2 btn-more">
                            <span>View more Products</span>
                        </a>
                    </div>


                    <hr class="mt-0 mb-4">


        </main><!-- End .main -->



        <%- include('../layouts/user/mobileview') %>
            <%- include('../layouts/user/userfooter') %>

                <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
                <script>
                    function addtoCart(proid, userid) {
                        const quentity = document.getElementById('qty').value;
                
                        // Make an AJAX request to the backend
                        fetch(`/addingcart/${proid}/${quentity}/${userid}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                quentity: quentity,
                            }),
                        })
                        .then((response) => {
                            if (response.status === 401) {
                                throw new Error('User not authenticated. Please login first.');
                            }
                            return response.json();
                        })
                        .then((data) => {
                            console.log('Response from backend:', data);
                
                            Swal.fire({
                                icon: 'success',
                                title: 'Product added to cart!',
                                showConfirmButton: false,
                                timer: 1500, 
                            });
                        })
                        .catch((error) => {
                            console.error('Error:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error adding to cart',
                                text: error.message || 'An error occurred while adding the product to the cart.',
                            });
                        });
                    }
                </script>
                

                </script>