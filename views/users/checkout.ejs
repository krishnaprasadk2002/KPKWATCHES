<%- include('../layouts/user/userHeader') %>
<%- include('../layouts/user/userNavBar') %>


        <main class="main">
            <div class="page-header text-center"
                style="background-image: url('../user/assets/images/page-header-bg.jpg')">
                <div class="container">
                    <h1 class="page-title">Checkout<span>Shop</span></h1>
                </div><!-- End .container -->
            </div><!-- End .page-header -->


            <div class="page-content">
                <div class="checkout">
                    <div class="container">
                        <div class="checkout-discount" hidden>
                            <form>
                                <input type="text" class="form-control" required id="checkout-discount-input">
                                <label for="checkout-discount-input" class="text-truncate">Have a coupon? <span>Click
                                        here to enter your code</span></label>
                            </form>
                        </div><!-- End .checkout-discount -->
                        <form action="#">
                            <div class="row">
                                <div class="col-lg-9">

                                    <h2 class="checkout-title">Select Address</h2><!-- End .checkout-title -->
                                    <br>



                                    <!-- selector method -->


                                    <!-- <select id="addressSelect" class="selectpicker" style="max-width: 200px;" required
                                        onchange="updateSelectedAddress()">
                                        <option disabled selected value="">Please select an address</option>
                                        <% if (user && user.address && user.address.length> 0) { %>
                                            <% user.address.forEach(Address=> { %>
                                                <option>
                                                    <%= `Name: ${Address.name}, Mobile: ${Address.mobile}, Address:
                                                        ${Address.address}, City: ${Address.city}, Pincode:
                                                        ${Address.pincode}, State: ${Address.state}` %>
                                                </option>
                                                <% }); %>
                                                    <% } else { %>
                                                        <option>No addresses found for this user.</option>
                                                        <% } %>
                                    </select>
                                    <div id="selectedAddress"></div> -->


                                    <div id="addressRadioGroup">
                                        <% if (user && user.address && user.address.length> 0) { %>
                                            <% user.address.forEach(Address=> { %>
                                                <div class="form-check address-container">
                                                    <input class="form-check-input" type="radio" name="selectedAddress"
                                                        id="<%= `address${Address._id}` %>"
                                                        value="<%= JSON.stringify(Address) %>">
                                                    <label class="form-check-label"
                                                        for="<%= `address${Address._Id}` %>">
                                                        <%= `Name: ${Address.name}, Mobile: ${Address.mobile}, Address:
                                                            ${Address.address}, City: ${Address.city}, Pincode:
                                                            ${Address.pincode}, State: ${Address.state}` %>
                                                    </label>
                                                </div>
                                                <% }); %>
                                                    <% } else { %>
                                                        <p>No addresses found for this user.</p>
                                                        <% } %>
                                    </div>

                                    <div id="selectedAddress"></div>

                                    <style>
                                        .address-container {
                                            border: 2px solid #ccc;
                                            padding: 10px;
                                            margin-bottom: 10px;
                                            padding-left: 20px;
                                        }
                                    </style>


                                    <div>
                                        <!-- Add Address button with the /address route -->
                                        <a href="/address" class="btn btn-primary btn-rounded mb-4 mt-3">Add Address</a>
                                    </div>


                                    <div class="checkout-discount">
                                        <form id="couponForm">

                                            <select id="couponCode" name="couponCode" style="max-width: 200px;"
                                                required>
                                                <option disabled selected value="">Please select an avilable coupon
                                                </option>
                                                <% if (coupon.length> 0) { %>
                                                    <% coupon.forEach(coupon=> { %>
                                                        <option>
                                                            <%= coupon.couponCode%>
                                                        </option>
                                                        <% }); %>
                                                            <% } else { %>
                                                                <option>No Coupons are Avilable.</option>
                                                                <% } %>
                                            </select>

                                            <div id="couponMessage" style="color: red;"></div>


                                            <label for="checkout-discount-input" class="text-truncate">Have a coupon?
                                                <span>Select here</span></label><br>
                                            <button class="btn btn-primary mt-4" type="button"
                                                onclick="applyCoupon()">Apply
                                                Coupon</button>

                                            
                                        </form>

                                    </div>




                                </div><!-- End .col-lg-9 -->





                                <aside class="col-lg-3">
                                    <div class="summary">
                                        <h3 class="summary-title">Your Order</h3><!-- End .summary-title -->

                                        <table class="table table-summary" id="load">
                                            <thead>
                                                <tr>
                                                    <th>Product</th>
                                                    <th>Total</th>
                                                </tr>
                                            </thead>


                                            <tbody>
                                                <% cartData.products.forEach((product)=>{%>
                                                    <tr>
                                                        <td><a href="#">Product Name</a></td>
                                                        <td>
                                                            <%= product.productId.name %>
                                                        </td>
                                                    </tr>
                                                    <%})%>

                                                        <!-- Add other product details as needed -->

                                                        <tr class="summary-subtotal">
                                                            <td>Subtotal:</td>
                                                            <td>₹<%= totalWithoutDiscount %>
                                                            </td>
                                                        </tr><!-- End .summary-subtotal -->

                                                        <tr>
                                                            <td>Shipping:</td>
                                                            <td>Free shipping</td>
                                                        </tr>

                                                        <% if (totalWithoutDiscount - totalWithDiscount> 0) { %>
                                                            <tr>
                                                                <td>Discount:</td>
                                                                <td>
                                                                    <%= totalWithoutDiscount - totalWithDiscount %>
                                                                </td>
                                                            </tr>
                                                            <% } %>


                                                                <tr class="summary-total">
                                                                    <td>Total:</td>
                                                                    <td>₹<%= totalWithDiscount %>
                                                                    </td>
                                                                </tr><!-- End .summary-total -->

                                            </tbody>
                                        </table><!-- End .table table-summary -->




                                        <div class="accordion-summary" id="accordion-payment">
                                            <!-- Add accordion summary details if needed -->

                                            <select name="paymentMethod" id="payment">
                                                <option value="Cash on delivery">Cash on delivery</option>
                                                <option value="Razorpay">Razorpay</option>
                                                <option value="wallet">Wallet</option>
                                            </select>
                                        </div><!-- End .accordion -->

                                        <button class="btn btn-outline-primary-2 btn-sorder btn-block"
                                            onclick="sendSelection()">
                                            Place Order
                                        </button>
                                    </div>
                                </aside><!-- End .col-lg-3 -->
                            </div><!-- End .summary -->

                    </div><!-- End .row -->
                    </form>
                </div><!-- End .container -->
            </div><!-- End .checkout -->
    </div><!-- End .page-content -->
    </main><!-- End .main -->




    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <!-- Option 2: Local download -->
    <!-- <script src="path/to/sweetalert2.all.min.js"></script> -->



    <script>
        function updateSelectedAddress() {
            // Get the selected radio button
            const selectedRadio = document.querySelector('input[name="selectedAddress"]:checked');

            // Update the selectedAddress div with the selected address details
            const selectedAddressDiv = document.getElementById('selectedAddress');
            if (selectedRadio) {
                const selectedAddress = JSON.parse(selectedRadio.value);
                selectedAddressDiv.innerHTML = `<p>SelectedAddress: ${selectedAddress.address}, ${selectedAddress.city}, ${selectedAddress.state}, ${selectedAddress.pincode}</p>`;
            } else {
                selectedAddressDiv.innerHTML = ''; // Clear the content if no address is selected
            }
        }
    </script>
    <!-- <script>
        function updateSelectedAddress() {
            // Get the selected option
            const selectedOption = document.getElementById('addressSelect').value;

            // Update the div with the selected address
            document.getElementById('selectedAddress').textContent = `Selected Address: ${selectedOption}`;
        }
    </script> -->



    <script>
        function sendSelection() {
            event.preventDefault();
            // Get the selected value from the payment dropdown
            const paymentMethod = document.getElementById("payment").value;

            // Get the selected address value (adjust this based on your HTML structure)
            // const selectedValue = document.getElementById("addressSelect").value;

            const selectedRadio = document.querySelector('input[name="selectedAddress"]:checked');

            const couponCode = document.getElementById('couponCode').value;

            // if (!selectedValue) {
            //     alert('please selcect a payment method & Address');
            //     return;
            // }

            if (!selectedRadio) {
                alert('Please select an address');
                return;
            }

            const selectedValue = JSON.parse(selectedRadio.value);


            fetch('/placeorder', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    paymentMethod: paymentMethod,
                    selectedValue: selectedValue,
                    couponCode: couponCode

                }),
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Backend response:', data);

                
                    if (data.success) {
                        Swal.fire({
                            title: 'Order Placed Successfully!',
                            icon: 'success',
                            showConfirmButton: false,
                            timer: 2000 

                        });

                        setTimeout(() => {

                            window.location.href = '/ordersuccess';
                        }, 2000)
                    }else if (data.message) {
            // Display SweetAlert error notification for product quantity check
            Swal.fire({
                title: 'Order Processing Failed',
                text: data.message,
                icon: 'error',
                confirmButtonText: 'OK'
            });
         } else if (data.response) {
                        var options = {
                            "key": 'rzp_test_TIOiShpd8euA17',
                            "amount": data.response.order.amount,
                            "currency": "INR",
                            "name": "KPK WATCHES", //your business name
                            "description": "Test Transaction",
                            "image": "https://example.com/your_logo",
                            "order_id": data.response.order.id,
                            "handler": function (response) {

                                verifyPayment(response, data.response)
                            },
                            "prefill": { //We recommend using the prefill parameter to auto-fill customer's contact information, especially their phone number
                                "name": "Gaurav Kumar", //your customer's name
                                "email": "gaurav.kumar@example.com",
                                "contact": "9000090000"  //Provide the customer's phone number for better conversion rates 
                            },
                            "notes": {
                                "address": "Razorpay Corporate Office"
                            },
                            "theme": {
                                "color": "#3399cc"
                            }
                        };
                        var rzp1 = new Razorpay(options);

                        rzp1.open();

                    } else {
                        // Display SweetAlert error notification
                        Swal.fire({
                            title: 'Order Processing Failed',
                            text: 'An error occurred while processing the order.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Handle errors if any
                });
        }

        function verifyPayment(payment, order) {
            $.ajax({
                url: '/varifypayment',
                data: {
                    payment,
                    order
                },
                method: 'post',
                success: (response) => {
                    if (response.payment) {

                        Swal.fire({
                            title: 'Order Placed Successfully!',
                            icon: 'success',
                            showConfirmButton: false,
                            timer: 2000 // Set the duration for the alert

                        });

                        setTimeout(() => {
                            // Redirect to the user cart page after the alert is closed
                            window.location.href = '/ordersuccess';
                        }, 2000)
                    }
                }
            })
        }
    </script>


    <script>

        async function applyCoupon() {

            const couponCode = document.getElementById('couponCode').value;

            console.log("req:", couponCode);
            event.preventDefault();
            try {
                const response = await fetch('/applyCoupon', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ couponCode }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    $('#load').load(`/checkout?coupon=${couponCode} #load`)
                    document.getElementById('couponMessage').innerHTML = data.success;
                } else if (data.already) {
                    document.getElementById('couponMessage').innerHTML = data.already;
                } else if (data.error) {
                    document.getElementById('couponMessage').innerHTML = data.error;
                }

            } catch (error) {
                console.error('Error:', error);

            }
        }

    </script>




<%- include('../layouts/user/mobileview') %>
<%- include('../layouts/user/smallFooter') %>

