<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Molla - Bootstrap eCommerce Template</title>
    <meta name="keywords" content="HTML5 Template">
    <meta name="description" content="Molla - Bootstrap eCommerce Template">
    <meta name="author" content="p-themes">
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="../user/assets/images/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../user/assets/images/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../user/assets/images/icons/favicon-16x16.png">
    <link rel="manifest" href="../user/assets/images/icons/site.html">
    <link rel="mask-icon" href="../user/assets/images/icons/safari-pinned-tab.svg" color="#666666">
    <link rel="shortcut icon" href="../user/assets/images/icons/favicon.ico">
    <meta name="apple-mobile-web-app-title" content="Molla">
    <meta name="application-name" content="Molla">
    <meta name="msapplication-TileColor" content="#cc9966">
    <meta name="msapplication-config" content="../user/assets/images/icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <!-- Plugins CSS File -->
    <link rel="stylesheet" href="../user/assets/css/bootstrap.min.css">
    <!-- Main CSS File -->
    <link rel="stylesheet" href="../user/assets/css/style.css">
</head>
<body>
<div class="page-wrapper">
    <header class="header">
        <div class="header-top">
            <div class="container">
                <div class="header-left">
                    <div class="header-dropdown">
                        <a href="#">Usd</a>
                        <div class="header-menu">
                            <ul>
                                <li><a href="#">Eur</a></li>
                                <li><a href="#">Usd</a></li>
                            </ul>
                        </div><!-- End .header-menu -->
                    </div><!-- End .header-dropdown -->

                    <div class="header-dropdown">
                        <a href="#">Eng</a>
                        <div class="header-menu">
                            <ul>
                                <li><a href="#">English</a></li>
                                <li><a href="#">French</a></li>
                                <li><a href="#">Spanish</a></li>
                            </ul>
                        </div><!-- End .header-menu -->
                    </div><!-- End .header-dropdown -->
                </div><!-- End .header-left -->

            </div><!-- End .container -->
        </div><!-- End .header-top -->

        <div class="header-middle sticky-header">
            <div class="container">
                <div class="header-left">
                    <button class="mobile-menu-toggler">
                        <span class="sr-only">Toggle mobile menu</span>
                        <i class="icon-bars"></i>
                    </button>

                    <a href="index.html" class="logo">
                        <img src="user/assets/images/logo.png" alt="Molla Logo" width="105" height="25">
                    </a>

                    <nav class="main-nav">
                        <ul class="menu sf-arrows">
                            <li class="megamenu-container active">
                                <a href="/home" >Home</a>

                              
                            </li>
                            <li>
                                <a href="category.html">Shop</a>

                              
                            </li>
                            <li>
                                <a href="product.html" >Product</a>

                            </li>
                            <li>
                                <a href="#" >About</a>

                            </li>
                            <li>
                                <a href="blog.html" >Blog</a>

                            </li>
                            <li>
                                <a href="elements-list.html" >Contact</a>
                            </li>
                        </ul><!-- End .menu -->
                    </nav><!-- End .main-nav -->
                </div><!-- End .header-left -->

                <div class="header-right">
                    <div class="header-search">
                        <a href="#" class="search-toggle" role="button" title="Search"><i class="icon-search"></i></a>
                        <form action="#" method="get">
                            <div class="header-search-wrapper">
                                <label for="q" class="sr-only">Search</label>
                                <input type="search" class="form-control" name="q" id="q" placeholder="Search in..." required>
                            </div><!-- End .header-search-wrapper -->
                        </form>
                    </div><!-- End .header-search -->
                   

                    <div class="dropdown cart-dropdown">
                        <a href="#" class="dropdown-toggle" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-display="static">
                            <i class="icon-shopping-cart"></i>
                            <span class="cart-count">2</span>
                        </a>

                        <div class="dropdown-menu dropdown-menu-right">
                            <div class="dropdown-cart-products">
                                <div class="product">
                                    <div class="product-cart-details">
                                        <h4 class="product-title">
                                            <a href="product.html">Beige knitted elastic runner shoes</a>
                                        </h4>

                                        <span class="cart-product-info">
                                            <span class="cart-product-qty">1</span>
                                            x $84.00
                                        </span>
                                    </div><!-- End .product-cart-details -->

                                    <figure class="product-image-container">
                                        <a href="product.html" class="product-image">
                                            <img src="user/assets/images/products/cart/product-1.jpg" alt="product">
                                        </a>
                                    </figure>
                                    <a href="#" class="btn-remove" title="Remove Product"><i class="icon-close"></i></a>
                                </div><!-- End .product -->

                                <div class="product">
                                    <div class="product-cart-details">
                                        <h4 class="product-title">
                                            <a href="product.html">Blue utility pinafore denim dress</a>
                                        </h4>

                                        <span class="cart-product-info">
                                            <span class="cart-product-qty">1</span>
                                            x $76.00
                                        </span>
                                    </div><!-- End .product-cart-details -->

                                    <figure class="product-image-container">
                                        <a href="product.html" class="product-image">
                                            <img src="user/assets/images/products/cart/product-2.jpg" alt="product">
                                        </a>
                                    </figure>
                                    <a href="#" class="btn-remove" title="Remove Product"><i class="icon-close"></i></a>
                                </div><!-- End .product -->
                            </div><!-- End .cart-product -->

                            <div class="dropdown-cart-total">
                                <span>Total</span>

                                <span class="cart-total-price">$160.00</span>
                            </div><!-- End .dropdown-cart-total -->

                            <div class="dropdown-cart-action">
                                <a href="cart.html" class="btn btn-primary">View Cart</a>
                                <a href="checkout.html" class="btn btn-outline-primary-2"><span>Checkout</span><i class="icon-long-arrow-right"></i></a>
                            </div><!-- End .dropdown-cart-total -->
                        </div><!-- End .dropdown-menu -->
                    </div><!-- End .cart-dropdown -->
                </div><!-- End .header-right -->
            </div><!-- End .container -->
        </div><!-- End .header-middle -->
    </header><!-- End .header -->
<style>
    .flash-message {
        padding: 10px;
        margin-bottom: 10px;
    }
    
    .error {
        background-color: #FFD2D2;
        color: #FF0000;
    }

</style>

<div class="otp-verification-page bg-image pt-8 pb-8 pt-md-12 pb-md-12 pt-lg-17 pb-lg-17" style="background-image: url(../user/assets/images/banners/countdown-begins-antique-timer-sand-flowing-endlessly-generated-by-ai.jpg)">
    <div class="container">
        <div class="form-box">
            <div class="form-tab">
                <ul class="nav nav-pills nav-fill" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="otp-verification-tab" data-toggle="tab" href="#otp-verification" role="tab" aria-controls="#otp-verification" aria-selected="true">OTP Verification</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="otp-verification" role="tabpanel" aria-labelledby="otp-verification-tab">
                        <form id="otpVerificationForm" action="/otp" method="post" onsubmit="return validateOtpForm()">
                            <% if(locals.email) { %>
                                <input type="hidden" name="email" value="<%= email %>">
                                <% } %>
                            <div class="form-group">
                                <label for="otp-code">Enter OTP *</label>
                                <input type="text" class="form-control" id="otp-code" name="Otp" required>
                            </div><!-- End .form-group -->

                            <div id="otp-timer" class="text-center"></div>

                            <div class="form-footer">
                                <button type="submit" class="btn btn-outline-primary-2">
                                    <span>VERIFY OTP</span>
                                    <i class="icon-long-arrow-right"></i>
                                </button>

                                <% if (locals.error && locals.error.length > 0) { %>
                                    <div class="flash-message error">
                                        <%= error %>
                                    </div>
                                <% } %>

                                <a href="/resendOtp?email=<%= email %>" class="resend-link">Resend OTP</a>
                            </div><!-- End .form-footer -->
                        </form>
                        <p class="text-danger"><%= otp %></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- <script>
    function getQueryParam(paramName) {
        const params = new URLSearchParams(window.location.search);
        return params.get(paramName);
    }

    document.addEventListener("DOMContentLoaded", function () {
        const timerElement = document.getElementById("otp-timer");
        const resendButton = document.querySelector(".resend-link");
        let countdown = 60; // Set the initial countdown time in seconds

        // Get the email from the URL parameters
        const email = getQueryParam('email');

        function updateTimerDisplay() {
            timerElement.textContent = `Resend OTP in ${countdown} seconds`;
        }

        function startTimer() {
            updateTimerDisplay();
            const timerInterval = setInterval(function () {
                countdown--;
                updateTimerDisplay();
                if (countdown <= 0) {
                    clearInterval(timerInterval);
                    timerElement.textContent = "Resend OTP";
                    // Enable Resend OTP button
                    resendButton.classList.remove("disabled");
                    // Update the click event listener for Resend OTP
                    resendButton.addEventListener("click", handleResendClick);
                }
            }, 1000);
        }

        function handleResendClick() {
            // Disable the Resend OTP button during the process
            resendButton.classList.add("disabled");

            // Swal.fire({
            //     icon: 'info',
            //     title: 'Sending OTP...',
            //     showConfirmButton: false,
            // });

            // Make an AJAX request to trigger the resend
            fetch("/admin/resendOtp", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ email: email }),
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data);
                    alert('OTP has been sent successfully!');
                    // Swal.fire({
                    //     icon: 'success',
                    //     title: 'OTP Sent!',
                    //     text: 'The OTP has been successfully sent to your email.',
                    // });
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                });
        }

        // Initially disable the Resend OTP button
        resendButton.classList.add("disabled");

        // Call startTimer() when the OTP is initially sent
        startTimer();
    });
</script> -->


<script>
    function getQueryParam(paramName) {
        const params = new URLSearchParams(window.location.search);
        return params.get(paramName);
    }

    document.addEventListener("DOMContentLoaded", function () {
        const timerElement = document.getElementById("otp-timer");
        const resendButton = document.querySelector(".resend-link");
        
        // Get the email from the URL parameters
        const email = getQueryParam('email');
        
        let timerResetRequested = false; // Flag to track if a timer reset is requested

        function updateTimerDisplay(countdown) {
            timerElement.textContent = `Resend OTP in ${countdown} seconds`;
        }

        function startTimer(countdown) {
            updateTimerDisplay(countdown);
            const timerInterval = setInterval(function () {
                countdown--;
                updateTimerDisplay(countdown);
                if (countdown <= 0) {
                    clearInterval(timerInterval);
                    timerElement.textContent = "Resend OTP";
                    // Enable Resend OTP button
                    resendButton.classList.remove("disabled");
                    // Update the click event listener for Resend OTP
                    resendButton.addEventListener("click", handleResendClick);
                    // Remove countdown from sessionStorage when it reaches 0
                    sessionStorage.removeItem('otpCountdown');
                }
            }, 1000);
        }

        function handleResendClick() {
            resendButton.classList.add("disabled");

            if (timerResetRequested) {
                let countdown = sessionStorage.getItem('otpCountdown');
                if (countdown === null || countdown <= 0) {
                    countdown = 60; 
                }

                startTimer(countdown);
                sessionStorage.setItem('otpCountdown', countdown);
            }


            fetch("/admin/resendOtp", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({ email: email }),
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log(data);
                    alert('OTP has been sent successfully!');

                    timerResetRequested = true;
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                });
        }

        let countdown = sessionStorage.getItem('otpCountdown');
        if (countdown === null || countdown <= 0) {
            countdown = 60; 
        }

        startTimer(countdown);
    });
</script>
